= Arquitectura del Software

Descripción de la arquitectura del sistema UnoSportClub.

== Arquitectura General

El sistema está construido con las siguientes tecnologías:

* Frontend: Angular
* Backend: Node.js con Express (Firebase Functions)
* Base de datos: PostgreSQL
* Autenticación: Firebase Auth
* API REST: `api/index.js` (Firebase Functions)

== Diagrama de Arquitectura

[source,asciidoc]
----
┌─────────────┐
│   Angular   │
│   Frontend  │
└──────┬──────┘
       │
       │ HTTP/REST
       │
┌──────▼──────────────┐
│  Firebase Functions │
│    api/index.js     │
│   (Express/Node.js) │
└──────┬──────────────┘
       │
       │ PostgreSQL Driver
       │
┌──────▼──────────────┐
│    PostgreSQL       │
│   Base de Datos     │
└─────────────────────┘

       │
       │ Firebase Auth
       │
┌──────▼──────────────┐
│   Firebase Auth     │
│  Autenticación      │
└─────────────────────┘
----

== Componentes Principales

=== Frontend (Angular)

El frontend está organizado en:

* `projects/panel/` - Aplicación principal del panel
* Componentes reutilizables
* Servicios de comunicación con API REST
* Guards y interceptores para autenticación
* WebSocket para notificaciones en tiempo real

=== Backend (Firebase Functions)

El backend está implementado en Firebase Functions:

* `api/index.js` - Punto de entrada principal de la API REST
* Express.js para manejo de rutas y middleware
* Conexión a PostgreSQL mediante driver nativo
* Autenticación mediante Firebase Auth tokens
* Webhooks para recibir notificaciones de pagos

=== Base de Datos (PostgreSQL)

PostgreSQL almacena:

* Todas las entidades del modelo de datos (RESERVATION, PAYMENT, CLIENT, etc.)
* Relaciones entre entidades mediante claves foráneas
* Índices para optimizar consultas de disponibilidad
* Transacciones para garantizar consistencia de datos

Ver xref:data-model.adoc[Modelo de Datos] para más detalles.

=== Autenticación (Firebase Auth)

Firebase Auth proporciona:

* Autenticación de usuarios (email/password, OAuth, etc.)
* Gestión de tokens JWT
* Verificación de tokens en el backend
* Integración con USER (no es tabla física, referencia a Firebase)

== Estructura del Proyecto

```
unosportclub/
├── projects/
│   └── panel/              # Frontend Angular
├── functions/
│   └── api/
│       └── index.js        # API REST principal (Firebase Functions)
├── docs/                    # Documentación
└── ...
```

== Flujo de Datos

1. El usuario interactúa con el frontend Angular
2. Las peticiones HTTP se envían a Firebase Functions (`api/index.js`)
3. Firebase Functions valida el token de autenticación
4. El backend procesa la lógica de negocio
5. Se accede a PostgreSQL para persistencia de datos
6. La respuesta se envía de vuelta al frontend
7. WebSocket notifica eventos en tiempo real (pagos, reservas)

== Seguridad

=== Autenticación

* Firebase Auth maneja la autenticación de usuarios
* Tokens JWT para sesiones
* Validación de tokens en cada petición a la API
* Refresh tokens para renovación automática

=== Autorización

* Roles y permisos por usuario (OPERATOR, CLIENT)
* Validación en backend (Firebase Functions)
* Guards en frontend (Angular)
* Verificación de permisos antes de operaciones sensibles

=== Base de Datos

* Conexiones seguras mediante SSL/TLS
* Prepared statements para prevenir SQL injection
* Validación de datos en múltiples capas
* Transacciones para operaciones críticas

== Escalabilidad

El sistema está diseñado para escalar:

* Firebase Functions escala automáticamente según demanda
* PostgreSQL puede escalarse vertical y horizontalmente
* Angular se puede optimizar con lazy loading y code splitting
* WebSocket maneja múltiples conexiones concurrentes
* Caché de consultas frecuentes (disponibilidad)

== Integraciones

=== Gateway de Pagos

* Webhook para recibir notificaciones de pagos
* Procesamiento asíncrono de pagos huérfanos
* Alineación automática de pagos con reservas

=== WebSocket

* Notificaciones en tiempo real de:
  * Pagos recibidos
  * Cambios de estado de reservas
  * Disponibilidad actualizada


